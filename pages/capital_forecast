from utils.imports import *
from utils.config import (
    inject_global_styles,
    inject_logo,
    get_supabase_client,
)
from cash_flow_forecast import create_cash_flow_forecast

# Page config & branding
st.set_page_config(
    page_title="CSL Capital | Capital Forecast",
    layout="wide",
)
inject_global_styles()
inject_logo()

# Load data
supabase = get_supabase_client()

@st.cache_data(ttl=3600)
def load_deals():
    res = supabase.table("deals").select("*").execute()
    return pd.DataFrame(res.data)

df = load_deals()

# Data preprocessing (same as your main dashboard)
cols_to_convert = ["amount", "total_funded_amount", "factor_rate", "loan_term", "commission"]
df["date_created"] = pd.to_datetime(df["date_created"], errors="coerce")
df[cols_to_convert] = df[cols_to_convert].apply(pd.to_numeric, errors="coerce")
closed_won = df[df["is_closed_won"] == True]

# Create forecast
create_cash_flow_forecast(df, closed_won)
